<!DOCTYPE html><html><head>
      <title>README</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////home/carer/.vscode/extensions/shd101wyy.markdown-preview-enhanced-0.8.19/crossnote/dependencies/katex/katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<div style="display:flex;align-items:center;">
  <img src="Saperlipopet_logo.png" alt="Logo" width="500">
  <h3 style="margin: 10px 0px 0px 50px;">Subtype Annotation with Prior Evaluation of the Reference LImits and Potential Outlier Population ExTraction</h3> 
</div>
<br>
<p>Pipeline originally developped to annotate the subtypes of NK cells. It is based on scANVI for the annotation and uses MapQC to detect new cell types that are not present in the original reference.</p>
<ul>
<li><a href="#1-usage-of-the-pipeline">1. Usage of the pipeline</a>
<ul>
<li><a href="#11-launching-the-pipeline">1.1. Launching the pipeline</a></li>
<li><a href="#12-inputs-description">1.2. Inputs description</a>
<ul>
<li><a href="#121-configuration-file">1.2.1. Configuration file</a></li>
<li><a href="#122-data-files">1.2.2. Data files</a></li>
</ul>
</li>
<li><a href="#13-potential-errors-or-problems">1.3. Potential errors or problems</a></li>
<li><a href="#14-outputs">1.4. Outputs</a></li>
</ul>
</li>
<li><a href="#2-advices-on-best-use-and-limits">2. Advices on best use and limits</a></li>
<li><a href="#3-results-interpretation">3. Results interpretation</a></li>
<li><a href="#4-mapqc-usage">4. MapQC usage</a></li>
<li><a href="#5-notes-for-future-developpers">5. Notes for future developpers</a></li>
</ul>
<h2 id="1-usage-of-the-pipeline">1. Usage of the pipeline </h2>
<h3 id="11-launching-the-pipeline">1.1. Launching the pipeline </h3>
<p>If you copied the files of the pipeline to another folder, start by updating the <code>SCRIPTS_DIR</code> variable at the top of the <code>Snakefile</code> : if the path to the <code>Snakefile</code> is <code>/mnt/some/path/Snakefile</code> it will be <code>/mnt/some/path</code>. Finally make sure that the Singularity images exist and that their paths at the top of the <code>Snakefile</code> are correct.<br>
To run the SAPERLIPOPExt pipeline, simply create virtual environment with :</p>
<pre data-role="codeBlock" data-info="console" class="language-console console"><code>virtualenv -p /usr/bin/python3 ~/.snakemake
source ~/.snakemake/bin/activate
pip install snakemake
pip install pulp==2.7.0
</code></pre><p>Then run the following :</p>
<pre data-role="codeBlock" data-info="console" class="language-console console"><code>snakemake --snakefile Snakefile --verbose --use-singularity --singularity-args="-B /mnt/DOSI:/mnt/DOSI -B $(pwd)/.cache:/home/jovyan/.cache --nv" --cores 5
</code></pre><p>Depending on your GPU capacity, you can adjust the number of cores. Usually, to run 4 models, it should take around 2 to 3h. Make sure that it is running on the GPU, otherwise it could take much longer (at least 10 times longer).</p>
<p>To create the containers you can first build the two Docker containers which Dockerfiles are in <code>SAPERLIPOPET/01_Containers/</code> and then create the Singularity image from the Docker images using :</p>
<pre data-role="codeBlock" data-info="console" class="language-console console"><code>docker run -v /var/run/docker.sock:/var/run/docker.sock \
-v /tmp/test:/output \
--privileged -t --rm \
quay.io/singularity/docker2singularity \
myDockerImageID
</code></pre><p>More detailed informations are present in the <code>readme.txt</code> of each container.</p>
<h3 id="12-inputs-description">1.2. Inputs description </h3>
<p><strong>Overview of the inputs :</strong></p>
<ul>
<li>Configuration file : <code>01_CONFIG.yaml</code>. Contains the paths to the reference, the query, etc. as well as the models parameters.</li>
<li>A <code>.rds</code> or <code>.h5ad</code> file containing respectively a <em>Seurat</em> object or an <em>Anndata</em> object for the reference.</li>
<li>A <code>.rds</code> or <code>.h5ad</code> file containing respectively a <em>Seurat</em> object or an <em>Anndata</em> object for the query.</li>
</ul>
<h4 id="121-configuration-file">1.2.1. Configuration file </h4>
<p>The <code>01_CONFIG.yaml</code> file must have the following fields :</p>
<ul>
<li><strong><code>reference_evaluation</code></strong> : whether the file to annotate, the query, is labeled. If it is, the labels will be used to compare with the annotation of the pipeline.</li>
<li><strong><code>reference_path</code></strong> : path to the <code>.rds</code> or <code>.h5ad</code> file containing respectively a <em>Seurat</em> object or an <em>Anndata</em> object for the reference.</li>
<li><strong><code>query_path</code></strong> : path to the <code>.rds</code> or <code>.h5ad</code> file containing respectively a <em>Seurat</em> object or an <em>Anndata</em> object for the reference.</li>
<li><strong><code>output_dir</code></strong> : path to the directory where the output files will be stored</li>
<li><strong><code>batch_key</code></strong> : name of the column in the metadata containing the samples/patient information. It is what will be used by scANVI to integrate. The pipeline runs on <strong>raw counts</strong>, so any prior integration will be discarded. Normally, there are several samples per dataset / study.</li>
<li><strong><code>study_key</code></strong> : name of the column in metadata containing the information about the dataset / study the cell belongs to. It should have a unique value in the query.<br>
=&gt; Both the <code>study_key</code> and the <code>batch_key</code> have to be the <strong>same in the query and in the reference</strong>.</li>
<li><strong><code>umap_name</code></strong> : name of the umap reduction in the <code>seurat_obj.rds</code>. It will be used in the following way : <code>seurat_obj@reductions[[umap_name]]@cell.embeddings</code>. If providing directly the <code>counts, metadata,...</code> set to any value (e.g. <code>False</code>).</li>
<li><strong><code>models_params</code></strong> : sets the number of models as well as their training parameters :
<ul>
<li><strong><code>ref_unlabeled_num_epochs</code></strong> : list with number of training epochs of the scVI model on the reference (thus without using the labels). This parameter doesn't seem to have much impact, between 20 and 200 seems like a good number. Please note that increasing the number of epochs will increase the computing time.</li>
<li><strong><code>ref_labeled_num_epochs</code></strong> : list with number of training epochs of the scANVI model on the reference (using the labels). Usually numbers between 10 and 40 give good results</li>
<li><strong><code>query_num_epochs</code></strong> : list with number of training epochs of the scANVI model on both the reference and the query. Usually numbers between 50 and 300 give good results</li>
<li><strong><code>prod</code></strong> : if set to True, the cartesian product of the <code>..._num_epochs</code> lists is used to create the models. If False, they all must have the same length and zip() will be used.<br>
=&gt; The number of models trained is determined by the values in the lists as well as the value of <code>prod</code>. When <code>prod</code> is <code>True</code>, there will be <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="monospace">len(ref_unlabeled_num_epochs)</mtext><mo>×</mo><mtext mathvariant="monospace">len(ref_labeled_num_epochs)</mtext><mo>×</mo><mtext mathvariant="monospace">len(query_num_epochs)</mtext></mrow><annotation encoding="application/x-tex">\texttt{len(ref\_unlabeled\_num\_epochs)} \times \texttt{len(ref\_labeled\_num\_epochs)} \times \texttt{len(query\_num\_epochs)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9167em;vertical-align:-0.2222em;"></span><span class="mord text"><span class="mord texttt">len(ref_unlabeled_num_epochs)</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9167em;vertical-align:-0.2222em;"></span><span class="mord text"><span class="mord texttt">len(ref_labeled_num_epochs)</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9167em;vertical-align:-0.2222em;"></span><span class="mord text"><span class="mord texttt">len(query_num_epochs)</span></span></span></span></span> different models. Otherwise, there will only be <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="monospace">len(ref_unlabeled_num_epochs)</mtext><mo>=</mo><mtext mathvariant="monospace">len(ref_labeled_num_epochs)</mtext><mo>=</mo><mtext mathvariant="monospace">len(query_num_epochs)</mtext></mrow><annotation encoding="application/x-tex">\texttt{len(ref\_unlabeled\_num\_epochs)} = \texttt{len(ref\_labeled\_num\_epochs)} = \texttt{len(query\_num\_epochs)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9167em;vertical-align:-0.2222em;"></span><span class="mord text"><span class="mord texttt">len(ref_unlabeled_num_epochs)</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9167em;vertical-align:-0.2222em;"></span><span class="mord text"><span class="mord texttt">len(ref_labeled_num_epochs)</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9167em;vertical-align:-0.2222em;"></span><span class="mord text"><span class="mord texttt">len(query_num_epochs)</span></span></span></span></span> models.</li>
</ul>
</li>
</ul>
<h4 id="122-data-files">1.2.2. Data files </h4>
<p>There are two ways to give the reference and query data to the pipeline : either through a <em>Seurat</em> object using a <code>.rds</code> file or through an <em>AnnData</em> using a <code>.h5ad</code> file. When naming those file, respect the exact extension name : don't use uppercase or alternative notations.</p>
<p>If you provide a <code>.rds</code> file it must follow those specifications :</p>
<ul>
<li>You must have joined all the <strong>raw counts</strong> layers together in the <code>RNA$counts</code> slot.</li>
<li>The <code>meta.data</code> must contain a column named <code>ident</code> containing the true cell identity in the reference (and when evaluating the reference in the query as well).</li>
<li>The <code>meta.data</code> must contain the columns whose names are defined in <code>batch_key</code> and <code>study_key</code>. The name in the query should be <strong>identical to that in the reference</strong>.</li>
<li>The UMAP reduction defined in the config file must exist at the following location : <code>seurat_obj@reductions[[</code><em><code>umap_name</code></em><code>]]@cell.embeddings</code>.</li>
<li>The gene names nomenclature has to match between the query and the reference. It is however not required that the same genes are present in the query and in the reference.</li>
</ul>
<p>If you provide a <code>.h5ad</code> file, it must meet the following requirements :</p>
<ul>
<li>The <strong>raw counts</strong> must be located in <code>adata.X</code>. No other layer is needed.</li>
<li>The <code>obs</code> DataFrame must contain a column named <code>ident</code> containing the true cell identity in the reference (and when evaluating the reference in the query as well).</li>
<li>The <code>obs</code> must contain the columns whose names are defined in <code>batch_key</code> and <code>study_key</code>. The name in the query should be <strong>identical to that in the reference</strong>.</li>
<li>The UMAP reduction defined in the config file must exist at the following location : <code>adata.obsm["umap"]</code>. For now, using <code>.h5ad</code> as input, it is not possible to select the name of the UMAP. Set the value of <code>umap_name</code> to some default value like <code>"random_text"</code>.</li>
<li>The gene names nomenclature (set in <code>adata.var_names</code>) has to match between the query and the reference. It is however not required that the same genes are present in the query and in the reference.</li>
</ul>
<h3 id="13-potential-errors-or-problems">1.3. Potential errors or problems </h3>
<ul>
<li>If scANVI takes an unreasonable amount of time to be imported ( &gt;10 min), restart the computing cluster, it should solve the issue.</li>
<li>If after running the pipeline, you realize that MapQC is not very useful because an important number of cells is grey (not sampled), consider increasing the <code>n_nhoods</code> parameter in  <code>02_Ann_methods/04_mapQC_evaluation.py</code>.</li>
</ul>
<h3 id="14-outputs">1.4. Outputs </h3>
<p>The annotations will be saved in <code>..._all_models_predictions_and_mapQC_scores.csv</code> where <code>...</code> corresponds to the name of the reference and that of the query.<br>
A summary of the results, including UMAPs of the prediction, of the MapQC scores and so forth will also be created under <code>ann_tools_benchmark_on_ref=</code><em><code>{name of reference}</code></em><code>_query=</code><em><code>{name of the query}</code></em><code>_</code><em><code>{date and time}</code></em><code>.html</code>.<br>
Finally, a folder named <em><code>{QUERY_NAME}</code></em><code>_ref=</code><em><code>{REF_NAME}</code></em><code>_intermediate_outputs</code> containing the different files generated during the pipeline.</p>
<h2 id="2-advices-on-best-use-and-limits">2. Advices on best use and limits </h2>
<p>The transfer of the labels between the reference and the query, depends mainly on the qulity of the reference.<br>
It appears that the pipeline is not capable of transfering labels to new organs, chemistry or sequencing technique. For instance, it won't be possible to annotate lung cells with only PBMC cells in the reference, or to annotate cells sequenced with V3 chemistry if in the reference all cells were sequenced with V2 or worse to annotate cells with singleNucleus data with a reference only made of singleCell data.</p>
<p>However, if your reference is made of PBMC cells sequenced with V2 chemistry as well as lung cells sequenced with V3 chemistry, you <em>should</em> be able to annotate lung cells with V2 chemistry or PBMC cells with V3 chemistry.<br>
It is also advised when annotating large datasets that you manually annotate at least one sample so as to evaluate the quality of your reference. This will give you an estimate of the quality of the annotation for the other samples. If the results are not satisfactory, it is advised to annotate manually a second sample, to add it to the reference and to evaluate once again the quality of the reference. Usually, if the original reference is comprised of enough cells, around 1000 cells in the new context should suffice to achieve good annotation performance.</p>
<p>Sometimes, it appears that adding unlabeled cells to the reference can increase performance. This might be due to the fact that it densifies the number of points in the latent space and allows for better clustering. However, it has proven not to be always the case, and some small performance degradation have been observed.</p>
<h2 id="3-results-interpretation">3. Results interpretation </h2>
<p>In the HTML report, there are different indicators of the quality of the annotation as well as a detection of outlier population using MapQC.</p>
<p>At the top, in the <strong>Overview</strong> tab, there is two figure showing how well the different models trained on the data agree with each other. If all the models agree with each other (score close to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>), it is usually a sign of a reliable annotation. However, although unlikely, it could simply be that they are all biased in the same way and all make the same mistake.</p>
<p>Underneath, you will find the aggregated results of MapQC. MapQC is a tool capable, given a query, a reference and a mapping between the two, to evaluate which cells in the query are outliers (cell population not present in the reference). Here the mapping used is the latent space of the <em>scANVI</em> model, therefore, MapQC is run as many times as there are models.  For a cell, a MapQC score below <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span> is a sign that the cell type belongs to those present in the reference. Conversely, a score above <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span> indicates either a poor integration (therefor a poor model) or a new cell type that was not present in the reference. Cells can also be marked as <em>Not sampled</em> or <em>Filtered out</em> this will be explained in more details in the section dedicated to MapQC.</p>
<p>On the <strong>Models</strong> tab, you will find the annotation given by each model as well their respective MapQC scores.</p>
<p>In the <code>..._all_models_predictions_and_mapQC_scores.csv</code> file, you will find the following columns :</p>
<ul>
<li>One column <code>predictions_...</code> per model, giving the prediction of this model</li>
<li>Similarly one column starting with <code>mapqc_score_...</code> or <code>binary_mapqc_score_...</code> per model. The binary MapQC score is useful in UMAPs to distinguish between outlier cells and non outliers as well as visualizing which cells were not sampled or filtered out.</li>
<li><code>final_prediction</code> giving the final prediction of the pipeline</li>
<li><code>pred_label_proportion</code> giving the proportion of models that "voted" for the cell type having receiving the most votes</li>
<li><code>proportion_difference</code> giving the difference in vote proportion between the first most voted type and the second most voted type (if you have 10 models, 5 that voted for cell type A, 2 that voted for cell type B and the rest all voted for other cell types, you would have a <code>proportion_difference</code> of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn><mo>−</mo><mn>2</mn><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">5-2 = 3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span>)</li>
<li><code>mapqc_median</code>, <code>mapqc_q3</code>, <code>mapqc_max</code> aggregating the MapQC score</li>
<li><code>binary_mapqc_median</code>,	<code>binary_mapqc_q3</code>,	<code>binary_mapqc_max</code> are the binarized version of the above columns (containing <code>Nan</code> if not a value)</li>
</ul>
<h2 id="4-mapqc-usage">4. MapQC usage </h2>
<p>If you see too many cells marked as <em>Not sampled</em>, increase <code>n_nhoods</code>. This raises the chance that each query cell is included in at least one neighborhood. You can start from <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="monospace">(number_of_query_cells</mtext><mtext>&nbsp;</mtext><mtext mathvariant="monospace">÷</mtext><mtext>&nbsp;</mtext><mtext mathvariant="monospace">k_min)</mtext><mtext>&nbsp;</mtext><mtext mathvariant="monospace">×</mtext><mtext>&nbsp;</mtext><mtext mathvariant="monospace">5</mtext></mrow><annotation encoding="application/x-tex">\texttt{(number\_of\_query\_cells ÷ k\_min) × 5}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9167em;vertical-align:-0.2222em;"></span><span class="mord text"><span class="mord texttt">(number_of_query_cells&nbsp;</span><span class="mord">÷</span><span class="mord texttt">&nbsp;k_min)&nbsp;</span><span class="mord">×</span><span class="mord texttt">&nbsp;5</span></span></span></span></span> and scale upward until coverage is sufficient. The only drawback of setting this parameter too high is a longer computing time. However, the calculation of the MapQC score is usually orders of magnitude smaller than that of scANVI so it is better to set it too high than too low.</p>
<p>If many cells are <em>Filtered out</em>, you can try raising <code>k_max</code> to allow neighborhoods to expand further, but keep it below <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>&nbsp;</mtext><mtext mathvariant="monospace">10×</mtext><mtext>&nbsp;</mtext><mtext mathvariant="monospace">k_min</mtext></mrow><annotation encoding="application/x-tex">\texttt{~10× k\_min}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7063em;vertical-align:-0.0951em;"></span><span class="mord text"><span class="mord texttt nobreak">&nbsp;</span><span class="mord texttt">10</span><span class="mord">×</span><span class="mord texttt">&nbsp;k_min</span></span></span></span></span> to avoid mixing in a single neighbourhood different cell types.</p>
<p>To get more hindsight on the reasons why cells were not included in the calculation of the MapQC score, you can take a look at the <code>logs/mapqc_logfile_...</code>. It mainly contains one table giving the reason why each of the neighbourhood was filtered out or not, another with the sample distances to reference and the last one being the <code>.obs</code> DataFrame of the AnnData after training of the model and thus with the embedding of the cells in the latent space.</p>
<p>It is also advised to read the <a href="https://mapqc.readthedocs.io/en/latest/notebooks/mapqc_detailed.html">MapQC documentation</a> which is very well done.</p>
<h2 id="5-notes-for-future-developpers">5. Notes for future developpers </h2>
<p>During development, I had quite a lot of issue using scanpy in a Singularity container. Especially, scanpy would start importing but never finish, running indefinitly. To solve this issue, I had to create cache directories in the <code>/tmp</code> of the Singularity container. So when importing scanpy in a file put the following code before :</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># Needed for the import of scanpy</span>
os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span><span class="token string">"/tmp/.cache"</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"NUMBA_CACHE_DIR"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/tmp/cache/numba_cache"</span>
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'MPLCONFIGDIR'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'/tmp/cache/mplconfig_cache'</span>
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"PYTORCH_KERNEL_CACHE_PATH"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/tmp/cache/torch_cache"</span>
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"FONTCONFIG_FILE"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/tmp/cache/fontconfig_cache"</span>
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"XDG_CACHE_HOME"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/tmp/cache"</span>
<span class="token keyword keyword-for">for</span> d <span class="token keyword keyword-in">in</span> <span class="token punctuation">[</span><span class="token string">"XDG_CACHE_HOME"</span><span class="token punctuation">,</span> <span class="token string">"NUMBA_CACHE_DIR"</span><span class="token punctuation">,</span> <span class="token string">"MPLCONFIGDIR"</span><span class="token punctuation">,</span> <span class="token string">"PYTORCH_KERNEL_CACHE_PATH"</span><span class="token punctuation">,</span> <span class="token string">"FONTCONFIG_FILE"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span>d<span class="token punctuation">]</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre><p>I faced similar issues when running Quarto in a Singularity container, which explains the <code>03_generate_report.py</code> file.</p>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>